-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local VirtualUser = game:GetService("VirtualUser")
local Workspace = game:GetService("Workspace")

-- Player references
local self = Players.LocalPlayer
local char = self.Character or self.CharacterAdded:Wait()
local root = char:WaitForChild("HumanoidRootPart")
local mouse = self:GetMouse()
local value = self:WaitForChild("Rebirths")

-- Load Rayfield
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- Window
local Window = Rayfield:CreateWindow({
	Name = "Shhhhh! - Meely & Adonis",
	LoadingTitle = "Miner's Haven Script",
	LoadingSubtitle = "By Skinny & Fat Studios",
	Theme = "Amethyst",
	KeySystem = false -- Set true if you want to use key system
})

-- Tabs and sections
local MainTab = Window:CreateTab("Farm")
MainTab:CreateSection("Auto")

-- New Tab for AutoCrate
local AutoCrateTab = Window:CreateTab("Auto")
AutoCrateTab:CreateSection("Crates")

-- State variables
local rebirthFarmingEnabled = false
local enableSecondLayout = false
local layoutDelay = 0
local layoutOne = "Layout1"
local layoutTwo = "Layout2"
local autoRebirthEnabled = false
local isAutoCrateEnabled = false
local autoCrateConnection = nil  -- Connection to stop when AutoCrate is disabled
local isAutoCrateActive = false  -- Track if AutoCrate is active
local isEasterEggEnabled = false
local stopEasterEggs = false

-- Anti-AFK
Players.LocalPlayer.Idled:Connect(function()
	VirtualUser:Button2Down(Vector2.new(0, 0), workspace.CurrentCamera.CFrame)
	task.wait(1)
	VirtualUser:Button2Up(Vector2.new(0, 0), workspace.CurrentCamera.CFrame)
end)

-- Functions for AutoCrate
local function startAutoCrate()
	if isAutoCrateActive then return end  -- Prevent multiple instances of AutoCrate

	isAutoCrateActive = true  -- Mark AutoCrate as active

	if not game.Workspace:FindFirstChild("Boxes") then
		warn("Boxes folder does not exist in Workspace!")
		return
	end

	-- Function to interact with crates
	local function interactWithCrates()
		for _, v1 in pairs(game.Workspace.Boxes:GetChildren()) do
			if v1:IsA("MeshPart") or v1:IsA("Part") then
				local OldPos = game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame
				game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame = v1.CFrame
				wait(.1)
				firetouchinterest(v1, game.Players.LocalPlayer.Character.HumanoidRootPart, 0)
				firetouchinterest(v1, game.Players.LocalPlayer.Character.HumanoidRootPart, 1)
				wait(.1)
				game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame = OldPos
			end
		end
	end

	-- Initial interaction with existing crates
	interactWithCrates()

	-- Handle new boxes as they are added
	autoCrateConnection = game.Workspace.Boxes.ChildAdded:Connect(function(v1)
		wait(.5)
		if v1:IsA("MeshPart") or v1:IsA("Part") then
			local OldPos = game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame
			game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame = v1.CFrame
			wait(.1)
			firetouchinterest(v1, game.Players.LocalPlayer.Character.HumanoidRootPart, 0)
			firetouchinterest(v1, game.Players.LocalPlayer.Character.HumanoidRootPart, 1)
			wait(.1)
			game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame = OldPos
		end
	end)

	-- Show notification when AutoCrate starts
	game.StarterGui:SetCore("SendNotification", {
		Title = "AutoCrate Script",
		Text = "Script Made By _Meely"
	})
end

local function stopAutoCrate()
	if not isAutoCrateActive then return end  -- If it's already stopped, don't do anything

	-- Disconnect the AutoCrate connection if it exists
	if autoCrateConnection then
		autoCrateConnection:Disconnect()
		autoCrateConnection = nil
	end

	isAutoCrateActive = false  -- Mark AutoCrate as inactive

	-- Show notification when AutoCrate stops
	game.StarterGui:SetCore("SendNotification", {
		Title = "AutoCrate Script",
		Text = "AutoCrate stopped."
	})
end

-- Main Functions
local function loadLayouts()
	task.spawn(function()
		ReplicatedStorage.Layouts:InvokeServer("Load", layoutOne)
		task.wait(layoutDelay)
		if enableSecondLayout then
			ReplicatedStorage.Layouts:InvokeServer("Load", layoutTwo)
		end
	end)
end

local function farmRebirth()
	task.spawn(function()
		while autoRebirthEnabled do
			ReplicatedStorage.Rebirth:InvokeServer(26)
			task.wait()
		end
	end)
end

-- UI Elements for Main Tab
MainTab:CreateToggle({
	Name = "Rebirth Farm",
	CurrentValue = false,
	Flag = "rebfarm",
	Callback = function(val)
		rebirthFarmingEnabled = val
		if val then
			loadLayouts()
			farmRebirth()
		end
	end
})

MainTab:CreateToggle({
	Name = "Enable Second Layout?",
	CurrentValue = false,
	Flag = "seclayout",
	Callback = function(val)
		enableSecondLayout = val
	end
})

MainTab:CreateToggle({
	Name = "Auto Rebirth",
	CurrentValue = false,
	Flag = "aReb",
	Callback = function(val)
		autoRebirthEnabled = val
		if val then
			farmRebirth()
		end
	end
})

-- Divider added below Auto Rebirth Toggle
MainTab:CreateDivider()

-- Create the "Layouts" section right after the divider
MainTab:CreateSection("Layouts")

MainTab:CreateInput({
	Name = "Time Between Layouts (Seconds)",
	PlaceholderText = "0",
	RemoveTextAfterFocusLost = true,
	Callback = function(val)
		layoutDelay = tonumber(val) or 0
	end
})

MainTab:CreateDropdown({
	Name = "Choose First Layout",
	Options = {"Layout1", "Layout2", "Layout3"},
	CurrentOption = "Layout1",
	Flag = "layoutone",
	Callback = function(option)
		layoutOne = option
		print("Selected:", option)
	end
})

MainTab:CreateDropdown({
	Name = "Choose Second Layout",
	Options = {"Layout1", "Layout2", "Layout3"},
	CurrentOption = "Layout2",
	Flag = "layoutwo",
	Callback = function(option)
		layoutTwo = option
		print("Selected:", option)
	end
})

-- UI Elements for AutoCrate Tab
AutoCrateTab:CreateToggle({
	Name = "AutoCrate",
	CurrentValue = isAutoCrateEnabled,
	Flag = "AutoCrateToggle",
	Callback = function(state)
		isAutoCrateEnabled = state
		if isAutoCrateEnabled then
			startAutoCrate()
		else
			stopAutoCrate()
		end
	end
})

-- Divider added between AutoCrate and Easter Egg toggle
AutoCrateTab:CreateDivider()

-- Create the "Easter" section right after the divider in the AutoCrate tab
AutoCrateTab:CreateSection("Easter")

-- Easter Egg Interaction Code
local function interactWithEasterEggs()
	local originalPosition = game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame  -- Save original position
	local easterthing = Workspace:FindFirstChild("Easter")
	if not easterthing then return end

	local mapthing = Workspace.Map:FindFirstChild("EGG_SPAWNS")
	if not mapthing then return end

	-- Easter Island Egg Spawns
	local eggSpawns = easterthing:FindFirstChild("EASTER ISLAND EGG SPAWNS")
	if eggSpawns then
		for _, v in ipairs(eggSpawns:GetChildren()) do
			if #v:GetChildren() > 0 then
				for _, child in ipairs(v:GetChildren()) do
					if stopEasterEggs then return end
					game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame = child.CFrame
					task.wait(.5)
					fireproximityprompt(child.ProximityPrompt)
					wait(.5)
				end
			end
		end
	end

	-- Map Egg Spawns interaction
	if mapthing then
		for _, v in ipairs(mapthing:GetChildren()) do
			if #v:GetChildren() > 0 then
				for _, child in ipairs(v:GetChildren()) do
					if stopEasterEggs then return end  -- Stop interaction if toggle is disabled
					print(child.Name)
					child:FindFirstChild("ProximityPrompt")
					game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame = child.CFrame
					task.wait(.5)
					fireproximityprompt(child.ProximityPrompt)
					wait(.5)
				end
			end
		end
	end

	-- Restore original position after all interactions are done
	game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame = originalPosition
end

AutoCrateTab:CreateToggle({
	Name = "AutoEgg",
	CurrentValue = isEasterEggEnabled,
	Flag = "EasterEggToggle",
	Callback = function(state)
		isEasterEggEnabled = state
		stopEasterEggs = not state  -- Stop interacting with Easter eggs when toggle is off
		if state then
			-- Start interacting with Easter eggs
			interactWithEasterEggs()
		else
			-- Return to original position if AutoEgg is toggled off
			local originalPosition = game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame
			game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame = originalPosition
		end
	end
})

-- Auto load when Rebirths value changes
value:GetPropertyChangedSignal("Value"):Connect(function()
	task.wait(0.75)
	if rebirthFarmingEnabled then
		loadLayouts()
	end
end)
